from AcSimulation import AcSimulationScipy, AcSimulationCuDSS
import os
import sys
import time
# 将上级目录加入 sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from Circuit import PG, TSV, MicroBump, BranchType, DTC, Circuit
import numpy as np
import matplotlib.pyplot as plt

# interposer_w = 20
# interposer_h = 15
# vdd = 1

# pg = PG(interposer_w, interposer_h)
# # with open("test_ref.sp", "w") as f:
# #     f.write(pg.__repr__())
# # exit()
# tsv = TSV()
# dtc = DTC()
# bump = MicroBump()
# ckt = pg.clone()

# # add tsv
# tsv_index = [(2, 4), (2, 9), (11, 11), (5, 10), (7, 7), (17, 10), (11, 6), (5, 0)]
# for x, y in tsv_index:
#     ckt.make_subcircuit(
#         tsv,
#         "tsv{}_{}".format(y + 1, x + 1),
#         [("c{}_{}".format(y + 1, x + 1), "top"), ("0", "bottom")],
#     )

# dtc_index = []
# for x, y in dtc_index:
#     ckt.make_subcircuit(
#         dtc,
#         "dtc{}_{}".format(y + 1, x + 1),
#         [("c{}_{}".format(y + 1, x + 1), "top"), ("0", "bottom")],
#     )

# chiplets = [(1, 3, 9, 12, 1.5, 3.8e9), (10, 3, 19, 12, 0.2, 2.4e9)]
# for k, (lx, ly, hx, hy, power, freq) in enumerate(chiplets):
#     for y in range(ly, hy):
#         for x in range(lx, hx):
#             ckt.make_subcircuit(
#                 bump,
#                 "bump{}_{}".format(y + 1, x + 1),
#                 [
#                     ("c{}_{}".format(y + 1, x + 1), "bottom"),
#                     ("die{}_sink".format(k), "top"),
#                 ],
#             )
#     C_ODC = 9 * power / vdd / vdd / freq
#     ESR = 0.25e-9 / C_ODC
#     ckt.make_branch(
#         "die{}_ESR".format(k),
#         BranchType.R,
#         "die{}_sink".format(k),
#         "die{}_mid".format(k),
#         ESR,
#     )
#     ckt.make_branch(
#         "die{}_ODC".format(k), BranchType.C, "die{}_mid".format(k), "0", C_ODC
#     )

# ckt.make_branch("die0_obs", BranchType.I, "die0_sink", "0", 1)
# typ, u, v, val, index = ckt.prepare_sim("0", ["die0_obs"])
# sim = AcSimulationCuDSS(typ, u, v, val)
# freqs = np.geomspace(0.1e9, 10e9, 200)
# z = []
# start_time = time.time()
# for f in freqs:
#     sim.set_freq(f)
#     sim.factorize()
#     sim.solve()
#     z.append(abs(sim.branch_voltage(index)[0].item()))
# z = np.array(z)
# print(np.sum(z[z > 0.1] - 0.1))
# # print(np.sum(z))
# print("worst impedance:", np.max(z))
# time_cost = time.time() - start_time
# print("time cost:", time_cost)
# plt.plot(freqs, z)
# plt.ylabel("Impedance[Ohm]")
# plt.yscale("log")
# plt.yticks()
# plt.xlabel("Frequency[Hz]")
# plt.xscale("log")
# plt.xticks()
# plt.tight_layout()
# plt.savefig("tmp.png")


ckt = Circuit()
ckt.make_branch("l0", BranchType.L, "n2", "n1", 0.5e-9)
ckt.make_branch("r0", BranchType.R, "n1", "0", 30e-3)
ckt.make_branch("c0", BranchType.C, "n2", "0", 100e-9)
ckt.make_branch("i0", BranchType.I, "0", "n2", 1)
fps = np.geomspace(100e3, 100e6, 300, True)
typ, u, v, val, index = ckt.prepare_sim("0", ["i0"])
sim = AcSimulationCuDSS(typ, u, v, val)
zpkg = []
print(typ)
print(u)
print(v)
print(val)
print(index)
# freq = 100e3
mat, rhs = sim.export()
print(mat.to_dense())
print(rhs)
for freq in fps:
    sim.set_freq(freq)
    sim.factorize()
    sim.solve()
    zpkg.append(abs(sim.branch_voltage(index)[0].item()))
print(zpkg)
plt.plot(fps, zpkg)
plt.ylabel("Impedance[Ohm]")
plt.yscale("log")
plt.yticks()
plt.xlabel("Frequency[Hz]")
plt.xscale("log")
plt.xticks()
plt.tight_layout()
plt.savefig("tmp.png")
print("done")



# list1 = [0.030002183807520587, 0.030002287079084738, 0.030002395234311533, 0.030002508504145393, 0.030002627130451768, 0.030002751366533534, 0.03000288147767187, 0.030003017741692634, 0.030003160449559592, 0.030003309905995635, 0.03000346643013344, 0.03000363035619679, 0.030003802034214246, 0.030003981830766434, 0.030004170129768762, 0.03000436733329108, 0.0300045738624161, 0.030004790158138474, 0.0300050166823063, 0.030005253918607134, 0.030005502373600727, 0.03000576257780046, 0.030006035086805983, 0.030006320482489416, 0.030006619374237514, 0.030006932400252748, 0.030007260228915703, 0.030007603560212023, 0.030007963127226735, 0.030008339697709246, 0.030008734075712324, 0.030009147103308546, 0.0300095796623879, 0.030010032676540326, 0.030010507113027322, 0.030011003984846636, 0.03001152435289464, 0.03001206932823086, 0.030012640074449617, 0.030013237810163622, 0.030013863811605142, 0.030014519415349897, 0.030015206021169888, 0.030015925095020914, 0.03001667817217133, 0.030017466860478625, 0.030018292843820897, 0.030019157885690442, 0.030020063832957102, 0.030021012619809544, 0.03002200627188265, 0.030023046910579967, 0.030024136757600392, 0.030025278139678667, 0.030026473493549817, 0.030027725371148156, 0.030029036445051824, 0.03003040951418453, 0.030031847509786515, 0.03003335350166767, 0.030034930704755845, 0.030036582485954384, 0.030038312371323574, 0.030040124053601115, 0.0300420214000777, 0.03004400846084438, 0.0300460894774293, 0.03004826889184212, 0.030050551356045355, 0.030052941741872705, 0.030055445151415523, 0.030058066927899352, 0.030060812667073715, 0.030063688229139265, 0.030066699751237696, 0.0300698536605307, 0.03007315668789594, 0.030076615882268908, 0.03008023862566115, 0.030084032648886625, 0.03008800604802952, 0.030092167301688413, 0.030096525289033296, 0.030101089308713587, 0.030105869098657274, 0.030110874856802975, 0.030116117262808766, 0.030121607500783697, 0.03012735728309005, 0.030133378875266573, 0.030139685122125375, 0.030146289475077723, 0.030153206020746125, 0.030160449510923473, 0.030168035393942232, 0.03017597984752, 0.03018429981315071, 0.030193013032114007, 0.030202138083178898, 0.030211694422081124, 0.03022170242285763, 0.030232183421125304, 0.03024315975939538, 0.030254654834519307, 0.030266693147366075, 0.030279300354836183, 0.030292503324322182, 0.030306330190731003, 0.030320810416188955, 0.03033597485255586, 0.03035185580688116, 0.03036848710994098, 0.030385904188002317, 0.030404144137967222, 0.030423245806057726, 0.030443249870210135, 0.03046419892635573, 0.030486137578773793, 0.0305091125347125, 0.03053317270348304, 0.03055836930024306, 0.030584755954697018, 0.0306123888249526, 0.030641326716785936, 0.03067163120858129, 0.03070336678222626, 0.030736600960258702, 0.030771404449578942, 0.03080785129205855, 0.030846019022396844, 0.03088598883359714, 0.03092784575045767, 0.030971678811496744, 0.031017581259758394, 0.031065650742974127, 0.031115989523587694, 0.031168704699184764, 0.031223908433906974, 0.03128171820147131, 0.031342257040461036, 0.03140565382260457, 0.031472043534813386, 0.031541567575810635, 0.031614374068248983, 0.03169061818729017, 0.031770462506700445, 0.031854077363606674, 0.03194164124315861, 0.03203334118445455, 0.032129373209211665, 0.032229942774800784, 0.03233526525341947, 0.03244556643934862, 0.03256108308642996, 0.03268206347811501, 0.032808768032675684, 0.03294146994643318, 0.033080455878160595, 0.03322602667814876, 0.0333784981657988, 0.0335382019600232, 0.033705486367206834, 0.03388071733200437, 0.03406427945684064, 0.0342565770966411, 0.0344580355360619, 0.034669102257321775, 0.03489024830767448, 0.03512196977661167, 0.03536478939406957, 0.03561925826224442, 0.03588595773512007, 0.03616550146150233, 0.03645853760925901, 0.03676575129061733, 0.037087867210801186, 0.03742565256503952, 0.03777992021209098, 0.038151532155957485, 0.038541403371461336, 0.0389505060139079, 0.03937987405822439, 0.039830608418850354, 0.040303882608361895, 0.04080094900046165, 0.04132314577170289, 0.041871904606301864, 0.04244875925981215, 0.043055355090507445, 0.043693459682284816, 0.044364974700036454, 0.045071949138058474, 0.04581659414450548, 0.04660129963054562, 0.047428652902112484, 0.04830145958539774, 0.04922276715487868, 0.050195891415055455, 0.05122444633439694, 0.052312377682237045, 0.05346400097609661, 0.05468404430705894, 0.05597769667227502, 0.05735066250266195, 0.05880922312412213, 0.06036030592201093, 0.0620115619750951, 0.06377145286197826, 0.06564934718148574, 0.06765562701015676, 0.06980180395553634, 0.07210064351838137, 0.07456629494670042, 0.0772144213442843, 0.08006232102994569, 0.08312902535473314, 0.08643534937971213, 0.09000385855981191, 0.09385869483820197, 0.09802517656189413, 0.10252904483906483, 0.10739517035621275, 0.11264545593155256, 0.11829557161796878, 0.12435005197829299, 0.13079520430774141, 0.13758930446103873, 0.14464985531255825, 0.1518385166672977, 0.15894601085060692, 0.16568202294363876, 0.17167827950244857, 0.17651453699245007, 0.1797735105913788, 0.18111903323019615, 0.180375120116442, 0.17757379697311007, 0.17294864518418704, 0.1668767917485508, 0.15979598131117428, 0.15212866013329718, 0.14423260514926672, 0.1363808592758942, 0.12876324760892024, 0.12149933406105992, 0.11465493493270575, 0.10825766302163582, 0.10230962136913802, 0.09679692248540246, 0.09169642177974408, 0.08698027057258068, 0.08261887415459432, 0.0785827345136206, 0.07484353855650314, 0.07137474974204436, 0.06815188134763621, 0.06515257155947723, 0.06235653988474891, 0.05974547655765256, 0.057302897917966014, 0.05501398835459258, 0.05286544129664117, 0.050845306486925625, 0.04894284742239076, 0.047148410743109374, 0.045453308062566145, 0.04384970996958125, 0.04233055150702201, 0.04088944822016008, 0.03952062178705875, 0.038218834242210536, 0.0369793298489558, 0.03579778374455354, 0.03467025656071815, 0.03359315430378544, 0.032563192857633774, 0.03157736654642365, 0.030632920261834447, 0.02972732472036619, 0.028858254470475044, 0.028023568317195144, 0.027221291873963677, 0.026449601988163842, 0.025706812819006844, 0.0249913633743382, 0.024301806337266293, 0.023636798034656868, 0.02299508941790483, 0.022375517942362585, 0.021777000245689567, 0.021198525537464936, 0.02063914962292237, 0.020097989492832678, 0.01957421841955375, 0.019067061506249497, 0.01857579164238694, 0.018099725823960758, 0.01763822180158265, 0.017190675023681677, 0.016756515845674474]
# list2 = [0.030002183807520573, 0.030002287079084745, 0.030002395234311533, 0.0300025085041454, 0.030002627130451768, 0.03000275136653354, 0.03000288147767188, 0.030003017741692624, 0.030003160449559595, 0.03000330990599563, 0.030003466430133446, 0.03000363035619677, 0.030003802034214242, 0.030003981830766444, 0.03000417012976875, 0.03000436733329108, 0.03000457386241611, 0.030004790158138474, 0.03000501668230629, 0.03000525391860714, 0.030005502373600716, 0.030005762577800445, 0.030006035086805986, 0.030006320482489426, 0.030006619374237528, 0.030006932400252737, 0.03000726022891571, 0.03000760356021203, 0.03000796312722672, 0.03000833969770924, 0.03000873407571233, 0.030009147103308546, 0.03000957966238789, 0.030010032676540326, 0.030010507113027315, 0.03001100398484665, 0.030011524352894642, 0.03001206932823087, 0.030012640074449596, 0.030013237810163625, 0.03001386381160515, 0.030014519415349893, 0.0300152060211699, 0.030015925095020903, 0.030016678172171317, 0.030017466860478615, 0.030018292843820904, 0.03001915788569044, 0.030020063832957102, 0.03002101261980954, 0.030022006271882645, 0.030023046910579977, 0.030024136757600385, 0.03002527813967868, 0.030026473493549814, 0.03002772537114816, 0.03002903644505183, 0.030030409514184536, 0.03003184750978652, 0.030033353501667664, 0.030034930704755828, 0.03003658248595437, 0.03003831237132359, 0.03004012405360111, 0.030042021400077723, 0.030044008460844384, 0.0300460894774293, 0.030048268891842138, 0.03005055135604535, 0.03005294174187271, 0.03005544515141552, 0.030058066927899356, 0.030060812667073708, 0.030063688229139254, 0.030066699751237696, 0.030069853660530707, 0.030073156687895945, 0.030076615882268905, 0.030080238625661147, 0.030084032648886618, 0.030088006048029515, 0.030092167301688417, 0.03009652528903329, 0.030101089308713583, 0.030105869098657274, 0.030110874856802985, 0.030116117262808762, 0.03012160750078369, 0.030127357283090038, 0.03013337887526657, 0.03013968512212539, 0.030146289475077716, 0.030153206020746125, 0.03016044951092347, 0.030168035393942236, 0.030175979847519997, 0.030184299813150718, 0.030193013032114, 0.0302021380831789, 0.030211694422081128, 0.030221702422857634, 0.0302321834211253, 0.030243159759395382, 0.030254654834519296, 0.03026669314736607, 0.030279300354836176, 0.030292503324322186, 0.030306330190730996, 0.030320810416188955, 0.030335974852555864, 0.03035185580688114, 0.030368487109940976, 0.03038590418800231, 0.03040414413796721, 0.03042324580605773, 0.03044324987021014, 0.030464198926355733, 0.03048613757877377, 0.03050911253471252, 0.03053317270348304, 0.030558369300243065, 0.03058475595469702, 0.030612388824952604, 0.030641326716785922, 0.030671631208581292, 0.030703366782226266, 0.030736600960258702, 0.030771404449578935, 0.030807851292058545, 0.030846019022396847, 0.03088598883359715, 0.03092784575045766, 0.030971678811496733, 0.031017581259758394, 0.031065650742974123, 0.031115989523587698, 0.031168704699184757, 0.03122390843390697, 0.03128171820147131, 0.03134225704046103, 0.03140565382260457, 0.03147204353481339, 0.03154156757581063, 0.03161437406824899, 0.031690618187290166, 0.031770462506700445, 0.03185407736360669, 0.03194164124315861, 0.03203334118445456, 0.032129373209211665, 0.032229942774800784, 0.032335265253419454, 0.032445566439348615, 0.032561083086429965, 0.032682063478115024, 0.032808768032675684, 0.03294146994643319, 0.0330804558781606, 0.033226026678148765, 0.03337849816579879, 0.03353820196002322, 0.03370548636720685, 0.03388071733200437, 0.03406427945684064, 0.03425657709664109, 0.03445803553606192, 0.034669102257321775, 0.034890248307674496, 0.03512196977661165, 0.03536478939406957, 0.035619258262244415, 0.03588595773512007, 0.036165501461502325, 0.036458537609259004, 0.03676575129061733, 0.03708786721080118, 0.03742565256503951, 0.03777992021209098, 0.038151532155957485, 0.038541403371461315, 0.0389505060139079, 0.03937987405822439, 0.03983060841885035, 0.04030388260836189, 0.040800949000461655, 0.041323145771702874, 0.04187190460630187, 0.04244875925981215, 0.04305535509050745, 0.043693459682284816, 0.044364974700036454, 0.04507194913805848, 0.045816594144505486, 0.046601299630545615, 0.047428652902112484, 0.048301459585397756, 0.04922276715487869, 0.05019589141505544, 0.051224446334396934, 0.052312377682237045, 0.053464000976096625, 0.054684044307058935, 0.05597769667227502, 0.05735066250266196, 0.058809223124122144, 0.060360305922010915, 0.062011561975095095, 0.06377145286197826, 0.06564934718148574, 0.06765562701015677, 0.06980180395553634, 0.07210064351838137, 0.07456629494670042, 0.07721442134428431, 0.08006232102994569, 0.08312902535473314, 0.08643534937971217, 0.09000385855981191, 0.09385869483820199, 0.0980251765618941, 0.10252904483906483, 0.1073951703562128, 0.11264545593155255, 0.11829557161796876, 0.124350051978293, 0.13079520430774141, 0.13758930446103873, 0.14464985531255822, 0.15183851666729767, 0.1589460108506069, 0.1656820229436388, 0.17167827950244857, 0.17651453699244996, 0.1797735105913788, 0.1811190332301962, 0.18037512011644205, 0.17757379697311004, 0.17294864518418698, 0.1668767917485508, 0.15979598131117426, 0.15212866013329715, 0.1442326051492667, 0.13638085927589422, 0.12876324760892024, 0.12149933406105991, 0.11465493493270573, 0.10825766302163584, 0.10230962136913802, 0.09679692248540246, 0.09169642177974408, 0.08698027057258066, 0.0826188741545943, 0.0785827345136206, 0.07484353855650315, 0.07137474974204436, 0.0681518813476362, 0.06515257155947722, 0.06235653988474891, 0.05974547655765257, 0.05730289791796601, 0.05501398835459258, 0.05286544129664116, 0.050845306486925625, 0.048942847422390766, 0.04714841074310938, 0.04545330806256616, 0.04384970996958125, 0.04233055150702201, 0.04088944822016007, 0.03952062178705876, 0.038218834242210536, 0.0369793298489558, 0.03579778374455353, 0.03467025656071815, 0.03359315430378544, 0.032563192857633774, 0.03157736654642366, 0.030632920261834444, 0.029727324720366186, 0.028858254470475044, 0.028023568317195144, 0.02722129187396368, 0.026449601988163842, 0.02570681281900684, 0.0249913633743382, 0.02430180633726629, 0.023636798034656868, 0.02299508941790483, 0.022375517942362585, 0.021777000245689567, 0.021198525537464936, 0.02063914962292237, 0.020097989492832678, 0.019574218419553747, 0.019067061506249497, 0.018575791642386943, 0.018099725823960758, 0.01763822180158265, 0.017190675023681674, 0.01675651584567447]